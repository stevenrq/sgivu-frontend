<div class="container-fluid">
  <app-page-header
    title="Gestión de Vehículos"
    subtitle="Administra el inventario de automóviles y motocicletas registrados en SGIVU."
  >
    <div
      page-header-actions
      class="d-flex align-items-center gap-3 flex-wrap justify-content-end"
    >
      <div class="btn-group toggle-group" aria-label="Tipo de vehículo">
        <button
          type="button"
          class="btn btn-outline-primary me-3"
          [class.active]="activeTab === 'car'"
          (click)="switchTab('car')"
          *appHasPermission="'car:read'"
        >
          <i class="bi bi-car-front-fill me-2"></i>Automóviles
        </button>
        <button
          type="button"
          class="btn btn-outline-primary"
          [class.active]="activeTab === 'motorcycle'"
          (click)="switchTab('motorcycle')"
          *appHasPermission="'motorcycle:read'"
        >
          <i class="bi bi-bicycle me-2"></i>Motocicletas
        </button>
      </div>
      <button
        class="btn btn-primary"
        type="button"
        (click)="startPurchaseFlow()"
        *appHasPermission="'purchase_sale:create'"
      >
        <i class="bi bi-plus-circle me-2"></i>{{ createLabel }}
      </button>
    </div>
  </app-page-header>

  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <app-kpi-card
        label="Inventario total"
        [value]="totalCount"
        [icon]="activeTab === 'car' ? 'bi-car-front-fill' : 'bi-bicycle'"
        variant="primary"
      ></app-kpi-card>
    </div>
    <div class="col-md-4">
      <app-kpi-card
        label="Disponibles"
        [value]="availableCount"
        icon="bi-check-circle-fill"
        variant="success"
      ></app-kpi-card>
    </div>
    <div class="col-md-4">
      <app-kpi-card
        label="No disponibles"
        [value]="unavailableCount"
        icon="bi-exclamation-triangle-fill"
        variant="warning"
      ></app-kpi-card>
    </div>
  </div>

  <div class="card">
    <div
      class="card-header bg-white py-3 d-flex flex-wrap align-items-center justify-content-between gap-3"
    >
      <div>
        <h5 class="card-title mb-1">
          {{
            activeTab === "car"
              ? "Automóviles registrados"
              : "Motocicletas registradas"
          }}
        </h5>
        <p class="text-muted small mb-0">
          Consulta, filtra y administra el estado de los vehículos registrados
          en el inventario.
        </p>
      </div>

      <div class="filters-panel" aria-label="Filtros">
        @if (activeTab === "car") {
          <div class="row g-2 g-md-3 align-items-end">
            <div class="col-6 col-md-3 col-xl-2">
              <label for="carPlate" class="form-label filter-label"
                >Placa</label
              >
              <input
                id="carPlate"
                type="search"
                class="form-control form-control-sm"
                [(ngModel)]="carFilters.plate"
                placeholder="Ej: ABC123"
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label for="carBrand" class="form-label filter-label"
                >Marca</label
              >
              <input
                id="carBrand"
                type="search"
                class="form-control form-control-sm"
                [(ngModel)]="carFilters.brand"
                placeholder="Toyota"
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label for="carLine" class="form-label filter-label">Línea</label>
              <input
                id="carLine"
                type="search"
                class="form-control form-control-sm"
                [(ngModel)]="carFilters.line"
                placeholder="SE"
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label for="carModel" class="form-label filter-label"
                >Modelo</label
              >
              <input
                id="carModel"
                type="search"
                class="form-control form-control-sm"
                [(ngModel)]="carFilters.model"
                placeholder="Corolla"
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label for="carFuel" class="form-label filter-label"
                >Combustible</label
              >
              <input
                id="carFuel"
                type="search"
                class="form-control form-control-sm"
                [(ngModel)]="carFilters.fuelType"
                placeholder="Gasolina"
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label for="carBody" class="form-label filter-label"
                >Carrocería</label
              >
              <input
                id="carBody"
                type="search"
                class="form-control form-control-sm"
                [(ngModel)]="carFilters.bodyType"
                placeholder="Sedán"
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label for="carTransmission" class="form-label filter-label"
                >Transmisión</label
              >
              <input
                id="carTransmission"
                type="search"
                class="form-control form-control-sm"
                [(ngModel)]="carFilters.transmission"
                placeholder="Automática"
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label for="carCity" class="form-label filter-label">Ciudad</label>
              <input
                id="carCity"
                type="search"
                class="form-control form-control-sm"
                [(ngModel)]="carFilters.cityRegistered"
                placeholder="Bogotá"
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label class="form-label filter-label" for="carStatus">Estado</label>
              <select
                id="carStatus"
                class="form-select form-select-sm"
                [(ngModel)]="carFilters.status"
              >
                <option value="">Todos</option>
                @for (status of vehicleStatuses; track status) {
                  <option [ngValue]="status">
                    {{ statusLabel(status) }}
                  </option>
                }
              </select>
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label class="form-label filter-label" for="carYearFrom"
                >Año desde</label
              >
              <input
                id="carYearFrom"
                type="number"
                min="1950"
                class="form-control form-control-sm"
                [ngModel]="carFilters.minYear"
                (ngModelChange)="carFilters.minYear = toNumber($event)"
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label class="form-label filter-label" for="carYearTo"
                >Año hasta</label
              >
              <input
                id="carYearTo"
                type="number"
                min="1950"
                class="form-control form-control-sm"
                [ngModel]="carFilters.maxYear"
                (ngModelChange)="carFilters.maxYear = toNumber($event)"
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label class="form-label filter-label" for="carMinPrice"
                >Precio mínimo</label
              >
              <input
                id="carMinPrice"
                type="number"
                min="0"
                class="form-control form-control-sm"
                [ngModel]="carFilters.minSalePrice"
                (ngModelChange)="carFilters.minSalePrice = toNumber($event)"
                placeholder="COP"
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label class="form-label filter-label" for="carMaxPrice"
                >Precio máximo</label
              >
              <input
                id="carMaxPrice"
                type="number"
                min="0"
                class="form-control form-control-sm"
                [ngModel]="carFilters.maxSalePrice"
                (ngModelChange)="carFilters.maxSalePrice = toNumber($event)"
                placeholder="COP"
              />
            </div>
            <div
              class="col-12 col-md-auto d-flex gap-2 justify-content-end mt-2 mt-md-3"
            >
              <button
                class="btn btn-primary btn-sm px-3"
                type="button"
                (click)="onCarSearch()"
              >
                <i class="bi bi-search me-1"></i>Filtrar
              </button>
              <button
                class="btn btn-outline-secondary btn-sm px-3"
                type="button"
                (click)="clearFilters('car')"
              >
                <i class="bi bi-arrow-counterclockwise me-1"></i>Limpiar
              </button>
            </div>
          </div>
        } @else {
          <div class="row g-2 g-md-3 align-items-end">
            <div class="col-6 col-md-3 col-xl-2">
              <label for="motoPlate" class="form-label filter-label"
                >Placa</label
              >
              <input
                id="motoPlate"
                type="search"
                class="form-control form-control-sm"
                [(ngModel)]="motorcycleFilters.plate"
                placeholder="Ej: ABC12D"
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label for="motoBrand" class="form-label filter-label"
                >Marca</label
              >
              <input
                id="motoBrand"
                type="search"
                class="form-control form-control-sm"
                [(ngModel)]="motorcycleFilters.brand"
                placeholder="Honda"
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label for="motoLine" class="form-label filter-label"
                >Línea</label
              >
              <input
                id="motoLine"
                type="search"
                class="form-control form-control-sm"
                [(ngModel)]="motorcycleFilters.line"
                placeholder="Repsol Edition"
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label for="motoModel" class="form-label filter-label"
                >Modelo</label
              >
              <input
                id="motoModel"
                type="search"
                class="form-control form-control-sm"
                [(ngModel)]="motorcycleFilters.model"
                placeholder="CB160F"
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label for="motoType" class="form-label filter-label">Tipo</label>
              <input
                id="motoType"
                type="search"
                class="form-control form-control-sm"
                [(ngModel)]="motorcycleFilters.motorcycleType"
                placeholder="Sport"
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label for="motoTransmission" class="form-label filter-label"
                >Transmisión</label
              >
              <input
                id="motoTransmission"
                type="search"
                class="form-control form-control-sm"
                [(ngModel)]="motorcycleFilters.transmission"
                placeholder="Manual"
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label for="motoCity" class="form-label filter-label">Ciudad</label>
              <input
                id="motoCity"
                type="search"
                class="form-control form-control-sm"
                [(ngModel)]="motorcycleFilters.cityRegistered"
                placeholder="Medellín"
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label class="form-label filter-label" for="motoStatus">Estado</label>
              <select
                id="motoStatus"
                class="form-select form-select-sm"
                [(ngModel)]="motorcycleFilters.status"
              >
                <option value="">Todos</option>
                @for (status of vehicleStatuses; track status) {
                  <option [ngValue]="status">
                    {{ statusLabel(status) }}
                  </option>
                }
              </select>
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label class="form-label filter-label" for="motoYearFrom"
                >Año desde</label
              >
              <input
                id="motoYearFrom"
                type="number"
                min="1950"
                class="form-control form-control-sm"
                [ngModel]="motorcycleFilters.minYear"
                (ngModelChange)="
                  motorcycleFilters.minYear = toNumber($event)
                "
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label class="form-label filter-label" for="motoYearTo"
                >Año hasta</label
              >
              <input
                id="motoYearTo"
                type="number"
                min="1950"
                class="form-control form-control-sm"
                [ngModel]="motorcycleFilters.maxYear"
                (ngModelChange)="
                  motorcycleFilters.maxYear = toNumber($event)
                "
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label class="form-label filter-label" for="motoMinPrice"
                >Precio mínimo</label
              >
              <input
                id="motoMinPrice"
                type="number"
                min="0"
                class="form-control form-control-sm"
                [ngModel]="motorcycleFilters.minSalePrice"
                (ngModelChange)="
                  motorcycleFilters.minSalePrice = toNumber($event)
                "
              />
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <label class="form-label filter-label" for="motoMaxPrice"
                >Precio máximo</label
              >
              <input
                id="motoMaxPrice"
                type="number"
                min="0"
                class="form-control form-control-sm"
                [ngModel]="motorcycleFilters.maxSalePrice"
                (ngModelChange)="
                  motorcycleFilters.maxSalePrice = toNumber($event)
                "
              />
            </div>
            <div
              class="col-12 col-md-auto d-flex gap-2 justify-content-end mt-2 mt-md-0"
            >
              <button
                class="btn btn-primary btn-sm px-3"
                type="button"
                (click)="onMotorcycleSearch()"
              >
                <i class="bi bi-search me-1"></i>Filtrar
              </button>
              <button
                class="btn btn-outline-secondary btn-sm px-3"
                type="button"
                (click)="clearFilters('motorcycle')"
              >
                <i class="bi bi-arrow-counterclockwise me-1"></i>Limpiar
              </button>
            </div>
          </div>
        }
      </div>
    </div>

    @if (activeState.error) {
      <div class="alert alert-danger rounded-0 mb-0">
        {{ activeState.error }}
      </div>
    }

    <div class="card-body p-0">
      <app-data-table
        [loading]="activeState.loading"
        [minHeight]="360"
        loadingLabel="Cargando vehículos..."
      >
        <ng-container table-head>
          @if (activeTab === 'car') {
            <tr>
              <th scope="col">Placa</th>
              <th scope="col">Marca / Línea</th>
              <th scope="col">Modelo</th>
              <th scope="col">Capacidad de pasajeros</th>
              <th scope="col">Transmisión</th>
              <th scope="col">Estado</th>
              <th scope="col" class="text-end">Precio venta</th>
              <th
                scope="col"
                class="text-center"
                *appHasPermission="
                  ['car:update', 'car:delete']; appHasPermissionLogic: 'OR'
                "
              >
                Acciones
              </th>
            </tr>
          } @else {
            <tr>
              <th scope="col">Placa</th>
              <th scope="col">Marca / Línea</th>
              <th scope="col">Modelo</th>
              <th scope="col">Tipo</th>
              <th scope="col">Estado</th>
              <th scope="col" class="text-end">Precio venta</th>
              <th
                scope="col"
                class="text-center"
                *appHasPermission="'motorcycle:update'"
              >
                Acciones
              </th>
            </tr>
          }
        </ng-container>
        <ng-container table-body>
          @if (activeTab === 'car') {
            @if (!activeState.loading && carState.items.length === 0) {
              <tr>
                <td class="text-center text-muted py-4" colspan="9">
                  No hay automóviles registrados para los filtros actuales.
                </td>
              </tr>
            }
            @for (car of carState.items; track car.id) {
              <tr>
                <td class="fw-semibold">{{ car.plate }}</td>
                <td>
                  <div class="fw-semibold">{{ car.brand }}</div>
                  <small class="text-muted">{{ car.line }}</small>
                </td>
                <td>{{ car.model }}</td>
                <td>{{ car.capacity }} pasajeros</td>
                <td>{{ car.transmission }}</td>
                <td>
                  <span class="badge" [ngClass]="badgeClass(car.status)">
                    {{ statusLabel(car.status) }}
                  </span>
                  <div class="mt-2" *appHasPermission="'car:update'">
                    <select
                      class="form-select form-select-sm"
                      [ngModel]="car.status"
                      (ngModelChange)="changeCarStatus(car, $event)"
                    >
                      @for (status of vehicleStatuses; track status) {
                        <option [value]="status">
                          {{ statusLabel(status) }}
                        </option>
                      }
                    </select>
                  </div>
                </td>
                <td class="text-end">
                  {{
                    car.salePrice | currency: 'COP': 'symbol-narrow': '1.0-0'
                  }}
                </td>
                <td class="text-center" *appHasPermission="'car:update'">
                  <div class="dropdown">
                    <button
                      class="btn btn-outline-secondary btn-sm btn-icon"
                      type="button"
                      data-bs-toggle="dropdown"
                      aria-expanded="false"
                    >
                      <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li>
                        <a
                          class="dropdown-item"
                          [routerLink]="['/vehicles/cars', car.id]"
                        >
                          <i class="bi bi-pencil-square me-2"></i>Editar
                        </a>
                      </li>
                      <li>
                        <button
                          class="dropdown-item d-flex align-items-center"
                          type="button"
                          (click)="toggleCarAvailability(car)"
                        >
                          <i
                            class="bi me-2"
                            [ngClass]="
                              car.status === VehicleStatus.INACTIVE
                                ? 'bi-toggle-off'
                                : 'bi-toggle-on'
                            "
                          ></i>
                          {{
                            car.status === VehicleStatus.INACTIVE
                              ? 'Activar'
                              : 'Desactivar'
                          }}
                        </button>
                      </li>
                    </ul>
                  </div>
                </td>
              </tr>
            }
          } @else {
            @if (!activeState.loading && motorcycleState.items.length === 0) {
              <tr>
                <td class="text-center text-muted py-4" colspan="8">
                  No hay motocicletas registradas para los filtros actuales.
                </td>
              </tr>
            }
            @for (motorcycle of motorcycleState.items; track motorcycle.id) {
              <tr>
                <td class="fw-semibold">{{ motorcycle.plate }}</td>
                <td>
                  <div class="fw-semibold">{{ motorcycle.brand }}</div>
                  <small class="text-muted">{{ motorcycle.line }}</small>
                </td>
                <td>{{ motorcycle.model }}</td>
                <td>{{ motorcycle.motorcycleType }}</td>
                <td>
                  <span class="badge" [ngClass]="badgeClass(motorcycle.status)">
                    {{ statusLabel(motorcycle.status) }}
                  </span>
                  <div class="mt-2" *appHasPermission="'motorcycle:update'">
                    <select
                      class="form-select form-select-sm"
                      [ngModel]="motorcycle.status"
                      (ngModelChange)="
                        changeMotorcycleStatus(motorcycle, $event)
                      "
                    >
                      @for (status of vehicleStatuses; track status) {
                        <option [value]="status">
                          {{ statusLabel(status) }}
                        </option>
                      }
                    </select>
                  </div>
                </td>
                <td class="text-end">
                  {{
                    motorcycle.salePrice
                      | currency: 'COP': 'symbol-narrow': '1.0-0'
                  }}
                </td>
                <td class="text-center" *appHasPermission="'motorcycle:update'">
                  <div class="dropdown">
                    <button
                      class="btn btn-outline-secondary btn-sm btn-icon"
                      type="button"
                      data-bs-toggle="dropdown"
                      aria-expanded="false"
                    >
                      <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li>
                        <a
                          class="dropdown-item"
                          [routerLink]="['/vehicles/motorcycles', motorcycle.id]"
                        >
                          <i class="bi bi-pencil-square me-2"></i>Editar
                        </a>
                      </li>
                      <li>
                        <button
                          class="dropdown-item d-flex align-items-center"
                          type="button"
                          (click)="toggleMotorcycleAvailability(motorcycle)"
                        >
                          <i
                            class="bi me-2"
                            [ngClass]="
                              motorcycle.status === VehicleStatus.INACTIVE
                                ? 'bi-toggle-off'
                                : 'bi-toggle-on'
                            "
                          ></i>
                          {{
                            motorcycle.status === VehicleStatus.INACTIVE
                              ? 'Activar'
                              : 'Desactivar'
                          }}
                        </button>
                      </li>
                    </ul>
                  </div>
                </td>
              </tr>
            }
          }
        </ng-container>
      </app-data-table>
    </div>

    @if (activeState.pager) {
      <div class="card-footer d-flex justify-content-end">
        <app-pager [pager]="activeState.pager!" [url]="pagerUrl"></app-pager>
      </div>
    }
  </div>
</div>
