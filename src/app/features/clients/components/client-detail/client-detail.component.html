<div class="container detail-container mt-5 mb-5">
  @if (isLoading) {
    <div class="text-center py-5">
      <div
        class="spinner-border text-primary"
        style="width: 3rem; height: 3rem"
      >
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">Cargando información del cliente...</p>
    </div>
  } @else if (errorMessage) {
    <div class="alert alert-danger" role="alert">
      <div
        class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3"
      >
        <div>
          <h5 class="alert-heading mb-1">No se pudo cargar el detalle</h5>
          <p class="mb-0">{{ errorMessage }}</p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <button
            class="btn btn-outline-danger"
            type="button"
            (click)="reload()"
          >
            <i class="bi bi-arrow-clockwise me-2"></i>Reintentar
          </button>
          <a class="btn btn-primary" [routerLink]="listLink">
            <i class="bi bi-arrow-left me-2"></i>Volver al listado
          </a>
        </div>
      </div>
    </div>
  } @else if (entity) {
    <div>
      <div class="detail-header text-center client-detail-hero">
        <img
          [src]="heroImageUrl"
          [alt]="'Avatar del cliente ' + heroTitle"
          class="detail-avatar client-avatar mb-3"
          loading="lazy"
        />
        <h1 class="detail-title">{{ heroTitle }}</h1>
        <p class="detail-subtitle">{{ heroSubtitle }}</p>
        <div class="mt-3 d-flex flex-wrap justify-content-center gap-2">
          <span class="badge detail-status-pill" [ngClass]="statusBadgeClass">
            {{ statusLabel }}
          </span>
          <span
            class="badge rounded-pill bg-light text-dark detail-status-pill"
          >
            ID #{{ entity.id }}
          </span>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-8">
          <div class="card detail-card mb-4">
            <div class="card-header detail-card-header">
              <i class="bi bi-info-circle me-2"></i>Información general
            </div>
            <div class="card-body detail-card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <p class="detail-info-label">Tipo de cliente</p>
                  <p class="detail-info-value mb-0">
                    <i
                      class="bi me-2"
                      [ngClass]="isPerson ? 'bi-person-badge' : 'bi-buildings'"
                    ></i
                    >{{ clientTypeLabel }}
                  </p>
                </div>
                <div class="col-md-6">
                  <p class="detail-info-label">{{ documentLabel }}</p>
                  <p class="detail-info-value mb-0">
                    <i class="bi bi-person-vcard me-2"></i
                    >{{ documentValue ?? "Sin registro" }}
                  </p>
                </div>
                @if (isPerson) {
                  <div class="col-md-6">
                    <p class="detail-info-label">Nombres</p>
                    <p class="detail-info-value">
                      {{ person?.firstName || "No registrado" }}
                    </p>
                  </div>
                  <div class="col-md-6">
                    <p class="detail-info-label">Apellidos</p>
                    <p class="detail-info-value">
                      {{ person?.lastName || "No registrado" }}
                    </p>
                  </div>
                } @else {
                  <div class="col-md-12">
                    <p class="detail-info-label">Razón social</p>
                    <p class="detail-info-value">
                      {{ company?.companyName || "No registrada" }}
                    </p>
                  </div>
                }
                <div class="col-md-6">
                  <p class="detail-info-label">Correo electrónico</p>
                  <p class="detail-info-value mb-0">
                    <i class="bi bi-envelope-at me-2"></i
                    >{{ entity.email || "Sin correo registrado" }}
                  </p>
                </div>
                <div class="col-md-6">
                  <p class="detail-info-label">Teléfono</p>
                  <p class="detail-info-value mb-0">
                    <i class="bi bi-telephone-forward me-2"></i
                    >{{ formatPhone(entity.phoneNumber) }}
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="card detail-card mb-4">
            <div class="card-header detail-card-header">
              <i class="bi bi-geo-alt me-2"></i>Ubicación y contacto
            </div>
            <div class="card-body detail-card-body">
              <div class="row g-3">
                <div class="col-md-8">
                  <p class="detail-info-label">Dirección</p>
                  <p class="detail-info-value mb-0">
                    <i class="bi bi-geo-fill me-2"></i>{{ addressLine }}
                  </p>
                </div>
                <div class="col-md-4">
                  <p class="detail-info-label">Ciudad</p>
                  <p class="detail-info-value mb-0">
                    <i class="bi bi-building me-2"></i
                    >{{ entity.address.city || "Pendiente" }}
                  </p>
                </div>
                <div class="col-md-6">
                  <p class="detail-info-label">Canal recomendado</p>
                  <p class="detail-info-value mb-0">
                    <span
                      class="badge bg-primary-subtle text-primary-emphasis detail-chip"
                    >
                      <i class="bi bi-chat-dots me-2"></i
                      >{{ bestContactChannel }}
                    </span>
                  </p>
                </div>
                <div class="col-md-6">
                  <p class="detail-info-label">Teléfono verificado</p>
                  <p class="detail-info-value mb-0">
                    <span
                      class="badge rounded-pill"
                      [ngClass]="
                        entity.phoneNumber
                          ? 'bg-success-subtle text-success-emphasis'
                          : 'bg-warning-subtle text-warning-emphasis'
                      "
                    >
                      {{ entity.phoneNumber ? "Registrado" : "Pendiente" }}
                    </span>
                  </p>
                </div>
                <div class="col-12">
                  <p class="detail-info-label mb-1">Completitud del perfil</p>
                  <div class="progress client-progress">
                    <div
                      class="progress-bar"
                      role="progressbar"
                      [style.width.%]="contactCompletion"
                      [attr.aria-valuenow]="contactCompletion"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    >
                      {{ contactCompletion }}%
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card detail-card mb-4">
            <div class="card-header detail-card-header">
              <i class="bi bi-check-circle me-2"></i>Salud de los datos
            </div>
            <div class="card-body detail-card-body">
              <p class="detail-section-title mb-3">Validaciones automáticas</p>
              <ul class="detail-list checklist">
                @for (item of contactChecklist; track item.label) {
                  <li>
                    <i
                      class="bi fs-4"
                      [ngClass]="
                        item.valid
                          ? 'bi-check-circle-fill text-success'
                          : 'bi-exclamation-circle-fill text-warning'
                      "
                    ></i>
                    <div>
                      <div class="fw-semibold">{{ item.label }}</div>
                      <small class="text-muted">{{ item.description }}</small>
                    </div>
                  </li>
                }
              </ul>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card detail-card mb-4">
            <div class="card-header detail-card-header">
              <i class="bi bi-lightning-charge me-2"></i>Acciones rápidas
            </div>
            <div class="card-body detail-card-body detail-actions">
              <a
                class="btn btn-primary"
                [routerLink]="editLink"
                *appHasPermission="updatePermission"
              >
                <i class="bi bi-pencil-square me-2"></i>Editar cliente
              </a>
              <button
                class="btn"
                [ngClass]="
                  entity.enabled ? 'btn-outline-danger' : 'btn-outline-success'
                "
                type="button"
                (click)="toggleStatus()"
                *appHasPermission="updatePermission"
              >
                <i
                  class="bi me-2"
                  [ngClass]="
                    entity.enabled ? 'bi-pause-circle' : 'bi-play-circle'
                  "
                ></i
                >{{ entity.enabled ? "Desactivar cliente" : "Activar cliente" }}
              </button>
              <a class="btn btn-outline-secondary" [routerLink]="listLink">
                <i class="bi bi-arrow-left me-2"></i>Volver al listado
              </a>
            </div>
          </div>

          <div class="card detail-card mb-4">
            <div class="card-header detail-card-header">
              <i class="bi bi-bar-chart-line me-2"></i>Resumen operativo
            </div>
            <div class="card-body detail-card-body">
              <div class="summary-item">
                <div>
                  <p class="detail-info-label mb-1">Estado actual</p>
                  <p class="detail-info-value mb-0">
                    <span
                      class="badge"
                      [ngClass]="
                        entity.enabled
                          ? 'bg-success-subtle text-success-emphasis'
                          : 'bg-secondary'
                      "
                    >
                      {{ statusLabel }}
                    </span>
                  </p>
                </div>
                <i class="bi bi-activity text-primary fs-4"></i>
              </div>
              <div class="summary-item">
                <div>
                  <p class="detail-info-label mb-1">Tipo de cliente</p>
                  <p class="detail-info-value mb-0">{{ clientTypeLabel }}</p>
                </div>
                <i
                  class="bi fs-4"
                  [ngClass]="
                    isPerson
                      ? 'bi-person-circle text-info'
                      : 'bi-building text-info'
                  "
                ></i>
              </div>
              <div class="summary-item">
                <div>
                  <p class="detail-info-label mb-1">
                    Recomendación de contacto
                  </p>
                  <p class="detail-info-value mb-0">{{ bestContactChannel }}</p>
                </div>
                <i class="bi bi-headset text-success fs-4"></i>
              </div>
            </div>
          </div>

          <div class="card detail-card mb-4">
            <div class="card-header detail-card-header">
              <i class="bi bi-card-list me-2"></i>Campos registrados
            </div>
            <div class="card-body detail-card-body">
              <div class="d-flex flex-wrap gap-2">
                <span
                  class="badge bg-light text-dark detail-chip"
                  [class.border-primary]="!!entity.email"
                >
                  <i
                    class="bi me-1"
                    [ngClass]="
                      entity.email
                        ? 'bi-check-circle-fill text-success'
                        : 'bi-dot'
                    "
                  ></i
                  >Correo
                </span>
                <span
                  class="badge bg-light text-dark detail-chip"
                  [class.border-primary]="!!entity.phoneNumber"
                >
                  <i
                    class="bi me-1"
                    [ngClass]="
                      entity.phoneNumber
                        ? 'bi-check-circle-fill text-success'
                        : 'bi-dot'
                    "
                  ></i
                  >Teléfono
                </span>
                <span
                  class="badge bg-light text-dark detail-chip"
                  [class.border-primary]="!!entity.address"
                >
                  <i
                    class="bi me-1"
                    [ngClass]="
                      entity.address
                        ? 'bi-check-circle-fill text-success'
                        : 'bi-dot'
                    "
                  ></i
                  >Dirección
                </span>
                <span
                  class="badge bg-light text-dark detail-chip"
                  [class.border-primary]="!!documentValue"
                >
                  <i
                    class="bi me-1"
                    [ngClass]="
                      documentValue
                        ? 'bi-check-circle-fill text-success'
                        : 'bi-dot'
                    "
                  ></i
                  >{{ isPerson ? "Documento" : "NIT" }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  }
</div>
