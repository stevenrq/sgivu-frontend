<div class="container-fluid dashboard-page">
  @if (loadError) {
    <div class="alert alert-danger mb-4" role="alert">{{ loadError }}</div>
  }

  <div class="row g-4 mb-4">
    <div class="col-md-6 col-xl-3">
      <app-kpi-card
        label="Vehículos en Inventario"
        [value]="totalInventory ?? '—'"
        icon="bi-car-front"
        variant="primary"
      ></app-kpi-card>
    </div>
    <div class="col-md-6 col-xl-3">
      <app-kpi-card
        label="Ventas del Mes"
        [value]="monthlySales ?? '—'"
        icon="bi-graph-up-arrow"
        variant="success"
      ></app-kpi-card>
    </div>
    <div class="col-md-6 col-xl-3">
      <app-kpi-card
        label="Ingresos del Mes"
        [value]="monthlyRevenueDisplay ?? '—'"
        icon="bi-cash-coin"
        variant="info"
      ></app-kpi-card>
    </div>
    <div class="col-md-6 col-xl-3">
      <app-kpi-card
        label="Vehículos por vender"
        [value]="vehiclesToSell ?? '—'"
        icon="bi-tag-fill"
        variant="warning"
      ></app-kpi-card>
    </div>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-xl-8">
      <div class="card h-100">
        <div
          class="card-header d-flex flex-wrap align-items-start align-items-md-center justify-content-between gap-2"
        >
          <div>
            <h5 class="card-title mb-1">Predicción de Demanda</h5>
            <div class="text-muted small">
              @if (activeSegmentLabel) {
                <span>{{ activeSegmentLabel }}</span>
              } @else {
                <span>Selecciona un segmento para pronosticar.</span>
              }
              @if (modelVersion) {
                <span class="ms-2 badge text-bg-light border">Modelo {{ modelVersion }}</span>
              } @else if (latestModel?.version) {
                <span class="ms-2 badge text-bg-light border">
                  Modelo {{ latestModel?.version }}
                </span>
              }
            </div>
          </div>
          <div class="d-flex flex-wrap gap-2 align-items-center">
            @if (forecastMetrics?.mape !== undefined) {
              <span class="badge bg-primary-subtle text-primary">
                MAPE {{ forecastMetrics?.mape | number: '1.1-2' }}
              </span>
            }
            @if (forecastMetrics?.rmse !== undefined) {
              <span class="badge bg-secondary-subtle text-secondary">
                RMSE {{ forecastMetrics?.rmse | number: '1.1-2' }}
              </span>
            }
            @if (salesHistoryCount > 0 && salesHistoryCount < 15) {
              <span class="badge bg-warning-subtle text-warning-emphasis">
                Historial corto: {{ salesHistoryCount }} ventas
              </span>
            }
          </div>
        </div>
        <div class="card-body">
          <form
            [formGroup]="predictionForm"
            (ngSubmit)="onSubmitPrediction()"
            class="quick-search mt-3"
          >
            <label class="form-label filter-label text-muted fw-semibold">
              Búsqueda rápida de vehículos
            </label>
            <div class="quick-search-wrapper">
              <input
                type="search"
                class="form-control"
                [(ngModel)]="quickVehicleTerm"
                (ngModelChange)="filterVehicleOptions($event)"
                placeholder="Escribe marca, modelo, placa o línea"
                autocomplete="off"
                [ngModelOptions]="{ standalone: true }"
              />
              <div class="quick-search-dropdown" *ngIf="contractedVehicles.length > 0">
                @for (
                  vehicle of contractedVehicles;
                  track vehicle.type + vehicle.id
                ) {
                  <button
                    type="button"
                    class="dropdown-item d-flex justify-content-between align-items-center"
                    (click)="selectQuickVehicle(vehicle)"
                  >
                    <div>
                      <div class="fw-semibold">
                        {{ vehicle.type === 'MOTORCYCLE' ? 'Moto' : 'Auto' }} ·
                        {{ vehicle.label }}
                        @if (vehicle.line) {
                          <span class="text-muted">({{ vehicle.line }})</span>
                        }
                      </div>
                      <div class="text-muted small">
                        @if (vehicle.line) {
                          Línea: {{ vehicle.line }} ·
                        }
                        Contratos: {{ vehicle.contractsCount ?? 0 }}
                      </div>
                    </div>
                    @if (quickVehicleLoading && quickVehicleTerm === vehicle.label) {
                      <span class="spinner-border spinner-border-sm"></span>
                    }
                  </button>
                }
              </div>
            </div>
              <div class="row g-2 align-items-end mt-2">
                <div class="col-6 col-md-3">
                  <label class="form-label small">Horizonte (meses)</label>
                  <input
                    type="number"
                  min="1"
                  max="24"
                  class="form-control"
                  formControlName="horizonMonths"
                />
              </div>
              <div class="col-12 col-md-auto">
                <button
                  class="btn btn-primary"
                  type="submit"
                  [disabled]="predictionLoading || quickVehicleLoading"
                >
                  @if (predictionLoading) {
                    <span
                      class="spinner-border spinner-border-sm me-2"
                      role="status"
                    ></span>
                  }
                  Consultar
                </button>
              </div>
            </div>
          </form>

          @if (predictionError) {
            <div
              class="alert alert-warning d-flex align-items-center gap-2 mb-3"
              role="alert"
            >
              <i class="bi bi-exclamation-triangle-fill"></i>
              <div>{{ predictionError }}</div>
            </div>
          }

          <div class="chart-container position-relative">
            @if (predictionLoading) {
              <div class="chart-placeholder text-center text-muted">
                <div class="spinner-border text-primary mb-2" role="status"></div>
                <div>Entrenando y calculando pronóstico...</div>
              </div>
            } @else if (demandData) {
              <div
                class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2"
              >
                <div class="text-muted small">
                  @if (latestModel?.trainedAt) {
                    Último entrenamiento: {{ latestModel?.trainedAt | date: 'medium' }}
                  }
                </div>
                <div class="d-flex flex-wrap gap-2">
                  @if (forecastMetrics?.r2 !== undefined) {
                    <span class="badge text-bg-light border">
                      R² {{ forecastMetrics?.r2 | number: '1.2-2' }}
                    </span>
                  }
                  @if (forecastMetrics?.residual_std !== undefined) {
                    <span class="badge text-bg-light border">
                      σ {{ forecastMetrics?.residual_std | number: '1.2-2' }}
                    </span>
                  }
                </div>
              </div>
              <canvas
                baseChart
                [data]="demandData"
                [options]="demandOptions"
                [type]="'line'"
                height="340"
              >
              </canvas>
            } @else {
              <div class="chart-placeholder text-center text-muted">
                Selecciona un vehículo en la búsqueda rápida y consulta para ver la predicción.
              </div>
            }
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="card-title mb-0">Composición del Inventario</h5>
        </div>
        <div
          class="card-body d-flex align-items-center justify-content-center inventory-chart"
        >
          @if (isLoading) {
            <div class="text-center text-muted py-4">
              <div class="spinner-border text-primary mb-2" role="status">
                <span class="visually-hidden">Cargando gráficos...</span>
              </div>
              <div>Preparando datos del inventario...</div>
            </div>
          } @else if (inventoryData) {
            <canvas
              baseChart
              [data]="inventoryData"
              [options]="inventoryOptions"
              [type]="'doughnut'"
              height="280"
            >
            </canvas>
          } @else {
            <div class="text-center text-muted py-4">
              No hay inventario registrado para mostrar.
            </div>
          }
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-7">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Actividad Reciente</h5>
        </div>
        <div class="recent-table-container table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th>Actividad</th>
                <th>Vehículo</th>
                <th>Fecha</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Venta</td>
                <td>Yamaha NMAX (HJK-12L)</td>
                <td>17/09/2025</td>
                <td><span class="badge bg-success">Completada</span></td>
              </tr>
              <tr>
                <td>Compra</td>
                <td>AKT NKD 125 (XYZ-78C)</td>
                <td>16/09/2025</td>
                <td><span class="badge bg-success">Completada</span></td>
              </tr>
              <tr>
                <td>Mantenimiento</td>
                <td>Toyota Hilux (QWE-45Z)</td>
                <td>15/09/2025</td>
                <td>
                  <span class="badge bg-info text-dark">En Progreso</span>
                </td>
              </tr>
              <tr>
                <td>Venta</td>
                <td>Mazda 3 (RTY-00F)</td>
                <td>14/09/2025</td>
                <td><span class="badge bg-success">Completada</span></td>
              </tr>
              <tr>
                <td>Documentación</td>
                <td>Suzuki Gixxer (ASD-99B)</td>
                <td>13/09/2025</td>
                <td>
                  <span class="badge bg-warning text-dark">Pendiente</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="card alerts-card h-100">
        <div class="card-header">
          <h5 class="card-title mb-0">Alertas Importantes</h5>
        </div>
        <div class="card-body alerts-card__body">
          <div class="list-group alerts-list">
          <a
            href="#"
            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start"
          >
            <div class="ms-2 me-auto">
              <div class="fw-bold">Documentación por Vencer</div>
              SOAT - Toyota Hilux (QWE-45Z)
            </div>
            <span class="badge bg-danger rounded-pill">Vence en 3 días</span>
          </a>
          <a
            href="#"
            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start"
          >
            <div class="ms-2 me-auto">
              <div class="fw-bold">Mantenimiento Próximo</div>
              Cambio de aceite - AKT NKD 125
            </div>
            <span class="badge bg-warning text-dark rounded-pill"
              >Próxima semana</span
            >
          </a>
          <a
            href="#"
            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start"
          >
            <div class="ms-2 me-auto">
              <div class="fw-bold">Documentación por Vencer</div>
              Tecnomecánica - Mazda 3 (RTY-00F)
            </div>
            <span class="badge bg-danger rounded-pill">Vence en 10 días</span>
          </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
