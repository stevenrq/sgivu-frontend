<div class="container-fluid">
  <app-page-header [title]="title" [subtitle]="subtitle">
    <div page-header-actions>
      <button
        class="btn btn-primary"
        [routerLink]="createLink"
        *appHasPermission="createPermission"
      >
        <i class="bi bi-plus-circle me-2"></i>{{ createLabel }}
      </button>
    </div>
  </app-page-header>

  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <app-kpi-card
        label="Usuarios Totales"
        [value]="totalUsers"
        icon="bi-people-fill"
        variant="primary"
      ></app-kpi-card>
    </div>
    <div class="col-md-4">
      <app-kpi-card
        label="Usuarios Activos"
        [value]="activeUsers"
        icon="bi-person-check-fill"
        variant="success"
      ></app-kpi-card>
    </div>
    <div class="col-md-4">
      <app-kpi-card
        label="Usuarios Inactivos"
        [value]="inactiveUsers"
        icon="bi-person-x-fill"
        variant="warning"
      ></app-kpi-card>
    </div>
  </div>

  <div class="card">
    <div class="card-header bg-white py-3">
      <div class="d-flex flex-wrap align-items-start justify-content-between">
        <div>
          <h5 class="card-title mb-1">Lista de Usuarios Registrados</h5>
          <p class="text-muted small mb-0">
            Combina filtros por nombre, credenciales, rol o estado para ubicar
            rápidamente a cualquier usuario.
          </p>
        </div>
      </div>
      <div class="filters-panel mt-3">
        <div class="row g-2 g-md-3 align-items-end">
          <div class="col-12 col-md-3">
            <label class="form-label filter-label">Nombre o apellido</label>
            <input
              type="search"
              class="form-control form-control-sm"
              [(ngModel)]="filters.name"
              (keyup.enter)="search()"
              [placeholder]="searchPlaceholder"
              maxlength="{{ searchTermMaxLength }}"
            />
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label filter-label">Nombre de usuario</label>
            <input
              type="search"
              class="form-control form-control-sm"
              [(ngModel)]="filters.username"
              (keyup.enter)="search()"
              placeholder="username"
            />
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label filter-label">Correo electrónico</label>
            <input
              type="email"
              class="form-control form-control-sm"
              [(ngModel)]="filters.email"
              (keyup.enter)="search()"
              placeholder="usuario@correo.com"
            />
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label filter-label">Rol</label>
            <select
              class="form-select form-select-sm"
              [(ngModel)]="filters.role"
            >
              <option value="">Todos</option>
              @for (role of roleOptions; track role) {
                <option [ngValue]="role">{{ role }}</option>
              }
            </select>
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label filter-label">Estado</label>
            <select
              class="form-select form-select-sm"
              [(ngModel)]="filters.enabled"
            >
              <option [ngValue]="null">Todos</option>
              <option [ngValue]="true">Activos</option>
              <option [ngValue]="false">Inactivos</option>
            </select>
          </div>
          <div class="col-12 col-md-auto filter-actions mt-2 mt-md-0">
            <button
              class="btn btn-primary btn-sm"
              type="button"
              (click)="search()"
            >
              <i class="bi bi-funnel me-1"></i>Aplicar filtros
            </button>
            <button
              class="btn btn-outline-secondary btn-sm"
              type="button"
              (click)="reset()"
            >
              <i class="bi bi-arrow-counterclockwise me-1"></i>Limpiar
            </button>
          </div>
        </div>
      </div>
    </div>

    @if (error) {
      <div class="alert alert-danger rounded-0 mb-0">
        {{ error }}
      </div>
    }

    <div class="card-body p-0">
      <app-data-table
        [loading]="isLoading"
        [minHeight]="300"
        loadingLabel="Cargando usuarios..."
      >
        <ng-container table-head>
          <tr>
            <th scope="col">Nombre Completo</th>
            <th scope="col">Correo Electrónico</th>
            <th scope="col">Nombre de Usuario</th>
            <th scope="col">Rol</th>
            <th scope="col">Estado</th>
            <th
              scope="col"
              class="text-center"
              *appHasPermission="'user:update'"
            >
              Acciones
            </th>
          </tr>
        </ng-container>
        <ng-container table-body>
          @for (user of users; track user.id) {
            <tr
              appRowNavigate
              [appRowNavigate]="['/users/profile', user.id]"
              [appRowNavigateDisabled]="isLoading"
            >
              <td>
                <div class="d-flex align-items-center">
                  <div class="avatar me-3">
                    {{ user.firstName.charAt(0) }}{{ user.lastName.charAt(0) }}
                  </div>
                  <div>
                    <span class="fw-semibold d-inline-flex flex-column">
                      <span>{{ user.firstName }} {{ user.lastName }}</span>
                    </span>
                    <div class="text-muted small">
                      {{ user.address.city }}
                    </div>
                  </div>
                </div>
              </td>
              <td>{{ user.email }}</td>
              <td>{{ user.username }}</td>
              <td>
                @for (role of user.roles; track role.id) {
                  @switch (role.name) {
                    @case ("ADMIN") {
                      <span class="badge bg-primary me-2">{{ role.name }}</span>
                    }
                    @case ("MANAGER") {
                      <span class="badge bg-info text-dark">{{
                        role.name
                      }}</span>
                    }
                    @case ("SALE") {
                      <span class="badge bg-secondary">{{ role.name }}</span>
                    }
                    @case ("PURCHASE") {
                      <span class="badge bg-dark">{{ role.name }}</span>
                    }
                    @case ("USER") {
                      <span class="badge badge-role-user me-2">
                        {{ role.name }}
                      </span>
                    }
                  }
                }
              </td>
              <td>
                @if (user.enabled) {
                  <span
                    class="badge bg-success-subtle text-success-emphasis rounded-pill"
                    >Activo</span
                  >
                } @else {
                  <span
                    class="badge bg-warning-subtle text-warning-emphasis rounded-pill"
                    >Inactivo</span
                  >
                }
              </td>
              <td class="text-center" *appHasPermission="'user:update'">
                <div>
                  <button
                    class="btn btn-outline-secondary btn-sm btn-icon"
                    type="button"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    <i class="bi bi-three-dots"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li>
                      <a
                        class="dropdown-item"
                        [routerLink]="['/users/profile', user.id]"
                      >
                        <i class="bi bi-eye me-2"></i>Ver detalle
                      </a>
                    </li>
                    <li>
                      <a
                        class="dropdown-item"
                        [routerLink]="['/users', user.id]"
                      >
                        <i class="bi bi-pencil-square me-2"></i>Editar
                      </a>
                    </li>
                    <li>
                      <hr class="dropdown-divider" />
                    </li>
                    <li>
                      <button
                        type="button"
                        class="dropdown-item d-flex align-items-center"
                        (click)="updateStatus(user.id, !user.enabled)"
                      >
                        <i
                          class="bi me-2"
                          [ngClass]="
                            user.enabled ? 'bi-toggle-on' : 'bi-toggle-off'
                          "
                        ></i>
                        {{ user.enabled ? "Desactivar" : "Activar" }}
                      </button>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>
          }
        </ng-container>
        <div
          table-empty
          class="text-center py-5 text-muted"
          *ngIf="!users.length && !isLoading && !error"
        >
          <i class="bi bi-people-slash display-6 d-block mb-2"></i>
          {{ emptyMessage }}
        </div>
      </app-data-table>
    </div>
    @if (pager) {
      <div
        class="card-footer bg-white d-flex justify-content-between align-items-center flex-wrap gap-2"
      >
        <span class="text-muted"
          >Mostrando {{ pager.numberOfElements }} de
          {{ pager.totalElements }} usuarios</span
        >
        <app-pager
          [pager]="pager"
          [url]="pagerUrl"
          [queryParams]="pagerQueryParams"
        ></app-pager>
      </div>
    }
  </div>
</div>
